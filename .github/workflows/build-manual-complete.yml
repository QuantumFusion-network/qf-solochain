name: Manual Build a Test Version

on:
  workflow_dispatch:
    inputs:
      ref:
        description: "Git branch"
        required: false
        default: 'main'

jobs:
  build_container:
    name: Build and Publish Container Image
    runs-on: qf-runner-pool
    permissions:
      contents: read
      packages: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          ref: ${{inputs.ref}}

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Prepare lowercase repository name
        id: repo
        run: |
          echo "lowercase=${GITHUB_REPOSITORY@L}" >> $GITHUB_OUTPUT

      - name: Build and Push
        id: docker_build
        uses: docker/build-push-action@v6
        with:
          context: .
          file: docker/Dockerfile.x86_64_testing
          push: true
          tags: theqfnetwork/qf-solochain-complete:${{ github.sha }}
          build-args: |
            QF_REF=${{ inputs.ref }}
          cache-from: type=registry,ref=ghcr.io/${{ steps.repo.outputs.lowercase }}:build-cache
          cache-to: type=registry,ref=ghcr.io/${{ steps.repo.outputs.lowercase }}:build-cache,mode=min,compression=zstd

      - name: Write Summary
        run: |
          IMAGE_TAG="theqfnetwork/qf-solochain-complete:${{ github.sha }}"
          DIGEST="${{ steps.docker_build.outputs.digest }}"
          
          echo "## :white_check_mark: Build Successful" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Image:** \`$IMAGE_TAG\`" >> $GITHUB_STEP_SUMMARY
          echo "**Digest:** \`$DIGEST\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Run Command" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker run $DIGEST" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
